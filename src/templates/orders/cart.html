{% extends 'base.html' %}
{% load static %}
{% load filters %}

{% block title %} Cart {% endblock %}


{% block content %}


<section id="about2">
    <h6 class="section-subtitle text-center">Your</h6>
    <h3 class="section-title mb-6 pb-3 text-center">Cart</h3>
    <div class="container">
        <div class="row mt-3" style="justify-content:space-around;">
        {% if cart %}
            {% for food,quantity in cart.items %}
            <div class="card mb-3" style="max-width:90%;">
                <div class="row g-0">
                    <div class="col-md-6">
                        <img src="{{ food.image.url }}" class="img-fluid img-thumbnail" alt="{{ food.title }}" style="height: 100%; width: 100%;">
                    </div>
                    <div class="col-md-6">
                        <div class="card-body" style="padding-right:2% ;padding-right:3%;">
                            <h5 class="card-title text-primary">{{ food.title }}</h5>
                            <div class="custom-list">
                                <div class="info">
                                    <div class="head clearfix">
                                        <div class="title float-left" style="font-size: 16px;">For each</div>
                                        <div class="float-right" style="font-size: 16px;">{{ food.price }} $</div>
                                    </div>
                                    <div class="head clearfix">
                                        <div class="title float-left" style="font-size: 16px;">Quantity</div>
                                        <div class="float-right" style="font-size: 16px;">{{ quantity }}</div>
                                </div>
                                <div class="head clearfix">
                                    <div class="title float-left " style="font-size: 16px;">Total</div>
                                    <div class="float-right" style="font-size: 16px;"><span class="item-total-price">{{ food.price|mul:quantity }}</span>$</div>
                                </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="col py-3">
                                <form action="{% url 'orders:cart_add' %}" method="POST">
                                    {% csrf_token %}
                                    <div class="row">
                                    <div class="col">
                                    <input type="number" name="quantity" id="" class="form-control" value="{{ quantity }}" min="1" style="width: 80%;" >
                                    </div>
                                    <div class="col py-1">
                                        <button type="submit_change" name="change" value="{{ food.id }}" class="btn btn-info btn-block" >Change</button>
                                    </div>
                                    </div>
                                </form>
                            </div>
                            <div class="col py-2">
                                <form method="post" action="{% url 'orders:cart_delete' %}">
                                    {% csrf_token %}
                                    <button type="submit" name="food" value="{{ food.id }}" class="btn btn-danger btn-block">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="text-center">
                <h3 class="text-center">Your cart is empty</h3>
                <br><br>
                <h4 class="text-center">Check out our menu to add foods to your cart</h4>
                <br>
                <a href="{% url 'foods:menu' %}"><button class="btn btn-primary btn-lg">Menu</button></a>
                <br>
            </div>
            {% endfor %}
        {% else %}
            <script>
                let cartData = JSON.parse(localStorage.getItem('cart'));
                let cartDataString = JSON.stringify(cartData);

                window.location.href = '/orders/cart/?cart_data=' + encodeURIComponent(cartDataString);
            </script>
        {% endif %}
        </div>
    </div>


{% if cart %}
<div class="container text-center head clearfix py-5" >
        <div class="col">
            <h4 class="py-2">Total orders price : <span class="text-primary" id="total-price"></span> </h4>
            {% endif %}
        </div>
            <div class="col py-2">
                {% if cart %}
                    {% if logged_in %}
                    <button id="sendDataButton" class="btn btn-success"  style="width: 50%;"><h4 style="padding-top:3%;">Set Order</h4></button>

                    <form id="orderForm" action="{% url 'orders:set_order' %}" method="post">
                        {% csrf_token %}
                        <input type="hidden" name="cart_data" id="cartDataInput">
                    </form>
                    {% endif %}
                {% endif %}
            </div>
</div>
</section>


<script>
document.getElementById('sendDataButton').addEventListener('click', function() {
    let cartData = JSON.parse(localStorage.getItem('cart'));
    let cartDataInput = document.getElementById('cartDataInput');
    cartDataInput.value = JSON.stringify(cartData);
    let orderForm = document.getElementById('orderForm');
    localStorage.removeItem('cart');
    orderForm.submit();
});
</script>

<script src="{% static 'js/cart.js' %}"></script>

{% endblock %}

